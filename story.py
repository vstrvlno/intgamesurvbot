# story.py
# Объединённый сюжет: Глава 1..5 — постапокалиптический квест про поиск вакцины.
# Ключи сцен — строки. Каждая сцена содержит:
#   "text": текст сцены,
#   "choices": словарь вариантов — ключ варианта -> {"text": "...", "next": "scene_key", ...}
# В вариантах может быть поле "role" (например, "soldier", "scientist", "scout"),
# которое сохраняется в players[user_id]["role"] в bot.py при выборе.

story = {
    # -----------------------
    # ГЛАВА 1: ПЕПЕЛЬНЫЙ РАССВЕТ
    # -----------------------
    "intro": {
        "text": (
            "Год 2089. После биокатастрофы, вызванной вирусом «Эпсилон», "
            "90% населения Земли исчезло. Города превратились в пустыни бетона.\n\n"
            "Ты стоишь на окраине разрушенного мегаполиса. "
            "Твоя цель — найти вакцину в центральной лаборатории 'Астра-9'.\n\n"
            "Но прежде чем сделать первый шаг, выбери, кто ты:"
        ),
        "choices": {
            "soldier": {"text": "Солдат — бывший офицер обороны.", "next": "ch1_arrival", "role": "soldier"},
            "scientist": {"text": "Учёный — участвовал в создании вируса.", "next": "ch1_arrival", "role": "scientist"},
            "scout": {"text": "Разведчик — выжил благодаря ловкости и скрытности.", "next": "ch1_arrival", "role": "scout"},
        },
    },

    "ch1_arrival": {
        "text": (
            "Ты входишь в город. Пепел скрипит под ногами. "
            "Ветер несёт запах гнили и ржавчины.\n"
            "На перекрёстке видны три пути:\n"
            "— направо к разбитому мосту,\n"
            "— налево в подземку,\n"
            "— прямо к выжженным улицам центра."
        ),
        "choices": {
            "right": {"text": "Пойти к мосту.", "next": "bridge_ruins"},
            "left": {"text": "Спуститься в подземку.", "next": "metro_entrance"},
            "forward": {"text": "Пойти по главной улице.", "next": "main_street"},
        },
    },

    "bridge_ruins": {
        "text": (
            "Мост разрушен. Внизу — тёмная река и обломки машин.\n"
            "На противоположной стороне мелькает фигура — возможно, человек.\n"
            "Но как добраться туда?"
        ),
        "choices": {
            "shout": {"text": "Крикнуть — вдруг услышит.", "next": "bridge_shout"},
            "climb": {"text": "Попробовать перелезть по арке.", "next": "bridge_climb"},
            "back": {"text": "Вернуться к перекрёстку.", "next": "ch1_arrival"},
        },
    },

    "bridge_shout": {
        "text": (
            "Ты кричишь, но фигура не отвечает. "
            "Вместо этого слышится гулкий рев — заражённые поблизости услышали тебя.\n"
            "Из-за угла выбегают двое мутантов."
        ),
        "choices": {
            "fight": {"text": "Сразиться с ними.", "next": "bridge_fight"},
            "run": {"text": "Бежать прочь!", "next": "bridge_escape"},
        },
    },

    "bridge_fight": {
        "text": (
            "Ты достаёшь оружие. Бой короткий, но жестокий.\n"
            "Ты побеждаешь, но теряешь немного здоровья."
        ),
        "choices": {
            "search": {"text": "Обыскать тела.", "next": "bridge_loot"},
            "return": {"text": "Вернуться назад.", "next": "ch1_arrival"},
        },
    },

    "bridge_loot": {
        "text": (
            "На одном из тел ты находишь флягу с водой и батарею.\n"
            "Энергия пригодится позже. Ты чувствуешь усталость, но идёшь дальше."
        ),
        "choices": {
            "continue": {"text": "Продолжить путь по мосту.", "next": "bridge_end"},
        },
    },

    "bridge_end": {
        "text": (
            "Ты добираешься до середины моста. "
            "Под тобой — чёрная бездна, вокруг — гул воды.\n"
            "Мост трещит. Нужно решать быстро."
        ),
        "choices": {
            "jump": {"text": "Прыгнуть на другую сторону.", "next": "bridge_jump"},
            "retreat": {"text": "Вернуться, пока не поздно.", "next": "ch1_arrival"},
        },
    },

    "bridge_jump": {
        "text": (
            "Ты разбегаешься и прыгаешь. Сердце замирает... "
            "Ты хватаешься за край бетона и подтягиваешься.\n"
            "На другой стороне лежит мёртвый солдат с рюкзаком.\n"
            "Внутри — старый планшет с координатами 'Астра-9'."
        ),
        "choices": {
            "take_tablet": {"text": "Взять планшет и уйти в центр.", "next": "main_street"},
        },
    },

    "bridge_escape": {
        "text": (
            "Ты бросаешься прочь. Мутанты преследуют тебя, но ты успеваешь спрятаться за автобусом.\n"
            "Дышишь тяжело. Спасся... но потерял часть снаряжения.\n"
            "Возвращаешься к перекрёстку."
        ),
        "choices": {
            "back": {"text": "Идти в другое направление.", "next": "ch1_arrival"},
        },
    },

    "bridge_climb": {
        "text": (
            "Попытка перелезть оказалась рискованной: камни сыплются. Ты скользишь и падаешь, но удерживаешься.\n"
            "Небольшое ранение, но продвинулся — видишь скрытую тропу к центру."
        ),
        "choices": {"proceed": {"text": "Идти по тропе к центру.", "next": "main_street"}},
    },

    "metro_entrance": {
        "text": (
            "Ты спускаешься в подземку. Темно и сыро. "
            "На стенах — следы крови и старые надписи: 'Не спускайся глубже!'\n"
            "Из туннеля слышны шаги."
        ),
        "choices": {
            "hide": {"text": "Спрятаться за колонной.", "next": "metro_hide"},
            "call": {"text": "Позвать — вдруг это человек.", "next": "metro_call"},
            "return": {"text": "Вернуться наверх.", "next": "ch1_arrival"},
        },
    },

    "metro_hide": {
        "text": (
            "Ты затаился. Мимо проходит бродяга с самодельным копьём.\n"
            "Он не замечает тебя. Когда он уходит, ты видишь ящик с метками ООН."
        ),
        "choices": {
            "open": {"text": "Открыть ящик.", "next": "metro_box"},
            "leave": {"text": "Не трогать и идти дальше.", "next": "metro_tunnel"},
        },
    },

    "metro_box": {
        "text": (
            "Внутри — запечатанные пакеты с медициной и дозиметр.\n"
            "Ты берёшь немного припасов и идёшь дальше.\n"
            "Туннель ведёт к старой станции."
        ),
        "choices": {
            "continue": {"text": "Двигаться к станции.", "next": "metro_tunnel"},
        },
    },

    "metro_call": {
        "text": (
            "Ты зовёшь. Из темноты выходит человек в противогазе.\n"
            "Он говорит хриплым голосом: 'Не ори... тут не одни мы.'\n"
            "Он предлагает обмен — информацию на припасы."
        ),
        "choices": {
            "trade": {"text": "Согласиться на обмен.", "next": "metro_trade"},
            "decline": {"text": "Отказаться и уйти.", "next": "metro_tunnel"},
        },
    },

    "metro_trade": {
        "text": (
            "Ты отдаёшь ему воду. Он сообщает, что вход в лабораторию под башней заперт, "
            "но можно пробраться через канализацию.\n"
            "Он уходит, оставляя карту с маршрутом."
        ),
        "choices": {
            "up": {"text": "Подняться на поверхность.", "next": "main_street"},
        },
    },

    "metro_tunnel": {
        "text": (
            "Ты идёшь по туннелю. С потолка капает вода. "
            "Слышен рев мутанта. Он перекрывает путь.\n"
            "Ты можешь сразиться или искать обход."
        ),
        "choices": {
            "fight": {"text": "Сразиться с мутантом.", "next": "metro_battle"},
            "sneak": {"text": "Пробраться мимо.", "next": "metro_sneak"},
        },
    },

    "metro_battle": {
        "text": (
            "Ты вступаешь в бой. Мутант огромен, но ты уклоняешься и наносишь удар.\n"
            "После долгой схватки побеждаешь, но получаешь ранения."
        ),
        "choices": {
            "exit": {"text": "Подняться на поверхность через шахту.", "next": "main_street"},
        },
    },

    "metro_sneak": {
        "text": (
            "Ты крадёшься мимо мутанта, задерживая дыхание.\n"
            "Он рычит, но не замечает тебя. Ты выходишь к шахте."
        ),
        "choices": {
            "climb": {"text": "Подняться на поверхность.", "next": "main_street"},
        },
    },

    "main_street": {
        "text": (
            "Ты выходишь на главную улицу. Впереди виднеется башня лаборатории.\n"
            "Но дорогу перекрывает баррикада и несколько вооружённых выживших."
        ),
        "choices": {
            "approach": {"text": "Подойти и поговорить.", "next": "camp_talk"},
            "hide": {"text": "Обойти с тыла.", "next": "camp_sneak"},
        },
    },

    "camp_talk": {
        "text": (
            "Лидер выживших смотрит на тебя подозрительно. "
            "'Ты кто такой? Зачем идёшь в башню?'\n"
            "От твоего ответа зависит всё."
        ),
        "choices": {
            "truth": {"text": "Сказать правду о вакцине.", "next": "camp_truth"},
            "lie": {"text": "Солгать, что ищешь еду.", "next": "camp_lie"},
        },
    },

    "camp_truth": {
        "text": (
            "Они переглядываются. Лидер вздыхает: 'Если правда, что ты спасёшь нас... держи ключ.'\n"
            "Он даёт тебе доступ к канализации под башней."
        ),
        "choices": {
            "go_tower": {"text": "Идти к лаборатории.", "next": "tower_entrance"},
        },
    },

    "camp_lie": {
        "text": (
            "Лидер хмурится. 'Врёшь. Мы видели таких — мародёров.'\n"
            "Он даёт сигнал, и выжившие поднимают оружие."
        ),
        "choices": {
            "fight": {"text": "Сражаться.", "next": "death_camp"},
            "flee": {"text": "Бежать в переулок.", "next": "tower_entrance"},
        },
    },

    "death_camp": {
        "text": (
            "Пули пронзают тело. Всё темнеет. "
            "Ты слышишь гул города, уходящий вдаль.\n\n❌ ТЫ ПОГИБ."
        ),
        "choices": {"restart": {"text": "Начать заново.", "next": "intro"}},
    },

    "camp_sneak": {
        "text": (
            "Ты обходишь лагерь и находишь люк, ведущий под землю. "
            "Путь к лаборатории открыт."
        ),
        "choices": {"enter": {"text": "Спуститься в канализацию.", "next": "tower_entrance"}},
    },

    "tower_entrance": {
        "text": (
            "Ты стоишь перед входом в башню 'Астра-9'. "
            "Из глубины доносится механический гул. "
            "Твоя судьба решится внутри.\n\n"
            "— Конец главы 1 —"
        ),
        "choices": {"next_chapter": {"text": "Продолжить в главе 2.", "next": "chapter_2_start"}},
    },

    # -----------------------
    # ГЛАВА 2: ПОДЗЕМЕЛЬЯ И СОЮЗЫ
    # -----------------------
    "chapter_2_start": {
        "text": (
            "Глава 2 — Подземелья и союзы.\n\n"
            "Ты спускаешься в старые коммуникации под башней. "
            "Вдоль стен повсюду надписи и граффити, кто-то пометил районы безопасными.\n"
            "Нужно решить: искать союзников, пробираться в одиночку или рискнуть контактировать с местными фракциями."
        ),
        "choices": {
            "seek_allies": {"text": "Искать союзников в подземном убежище.", "next": "under_sanctum"},
            "solo": {"text": "Пробираться в одиночку через тоннели.", "next": "shadow_pass"},
            "contact": {"text": "Пойти на риск и отыскать фракцию торговцев.", "next": "trade_haven"},
        },
    },

    "under_sanctum": {
        "text": (
            "Ты находишь убежище группы 'Санктум' — бывших инженеров и защитников метро.\n"
            "Они осторожны, но соглашаются поговорить при условии — помощь с дезактивацией ловушки."
        ),
        "choices": {
            "help_trap": {"text": "Помочь дезактивировать ловушку.", "next": "trap_success"},
            "refuse": {"text": "Отказаться и уйти.", "next": "shadow_pass"},
            "negotiate": {"text": "Постараться договориться, не помогая.", "next": "negotiation_fail"},
        },
    },

    "trap_success": {
        "text": (
            "Ты аккуратно обезвреживаешь механическую ловушку. Санктум признает твою ценность "
            "и даёт тебе карту подземных ходов и радиопередатчик."
        ),
        "choices": {
            "use_map": {"text": "Использовать карту — идти напрямую к серверной.", "next": "server_approach"},
            "keep_moving": {"text": "Продолжить без карты — действовать по интуиции.", "next": "shadow_pass"},
        },
    },

    "negotiation_fail": {
        "text": (
            "Договориться не удалось: подозрения сильнее. Один из них пытается схватить тебя.\n"
            "Разгорается драка."
        ),
        "choices": {
            "fight": {"text": "Драться.", "next": "fight_sanctum"},
            "flee": {"text": "Убежать.", "next": "shadow_pass"},
        },
    },

    "fight_sanctum": {
        "text": (
            "Ты проигрываешь — слишком много противников. Тебя ранят и оставляют в клетке подземелья.\n\n"
            "❌ ПОРАЖЕНИЕ: не удалось завоевать доверие и избежать конфликта."
        ),
        "choices": {"restart": {"text": "Начать заново.", "next": "intro"}},
    },

    "shadow_pass": {
        "text": (
            "Ты пробираешься по узким тоннелям — следы шагов, тёмные затхлые камеры.\n"
            "Внезапно слышен электрический треск: монитор на стене мигает сообщением о патруле."
        ),
        "choices": {
            "hide": {"text": "Укрыться и подождать.", "next": "evade_patrol"},
            "rush": {"text": "Пройти быстро, стараясь не шуметь.", "next": "silent_run"},
            "back": {"text": "Вернуться назад к входу.", "next": "chapter_2_start"},
        },
    },

    "evade_patrol": {
        "text": (
            "Ты затаился в нише. Патруль проходит мимо, не замечая тебя.\n"
            "В кармане — найдено небольшое устройство: помехогенератор."
        ),
        "choices": {
            "take_device": {"text": "Взять устройство (полезно позже).", "next": "server_approach"},
            "leave_device": {"text": "Не брать — опасно носить.", "next": "server_approach"},
        },
    },

    "silent_run": {
        "text": (
            "Ты бежишь, но запинаешься о металлическую решётку: сигналы вздымаются и загорается фонарь.\n"
            "Патруль замечает и атакует."
        ),
        "choices": {
            "fight_patrol": {"text": "Сразиться.", "next": "patrol_fight"},
            "surrender": {"text": "Сдаться — надежда на милость.", "next": "captured_patrol"},
        },
    },

    "patrol_fight": {
        "text": (
            "Бой короткий. Ты наносишь урон, но получаешь травму. "
            "Тем не менее, находишь в экипировке патруля ключ-карту."
        ),
        "choices": {"take_key": {"text": "Взять карту и идти к серверной.", "next": "server_approach"}},
    },

    "captured_patrol": {
        "text": (
            "Тебя берут в плен. Некие эксперименты над пленными уже начались.\n\n"
            "❌ ПОРАЖЕНИЕ: пойман и не смог спастись."
        ),
        "choices": {"restart": {"text": "Начать заново.", "next": "intro"}},
    },

    "trade_haven": {
        "text": (
            "Торговая фракция 'Хейвен' контролирует часть туннелей: обмен припасов на информацию.\n"
            "Лидер предлагает три варианта: помощь в охране, купля информации или шантаж."
        ),
        "choices": {
            "guard": {"text": "Помочь охранять склад.", "next": "guard_job"},
            "buy_info": {"text": "Купить информацию (если есть ресурсы).", "next": "bought_map"},
            "blackmail": {"text": "Попытаться шантажировать лидера.", "next": "blackmail_fail"},
        },
    },

    "guard_job": {
        "text": (
            "Ты работаешь на Хейвен — сутки на складе. За это даётся немного провианта и ценная карта с маршрутом канализации."
        ),
        "choices": {"use_map": {"text": "Взять карту и идти к серверной.", "next": "server_approach"}},
    },

    "bought_map": {
        "text": (
            "Карта куплена — она указывает на техническую шлюзовую комнату под лабораторией.\n"
            "Однако теперь за тобой следят торговцы: держись подальше от них."
        ),
        "choices": {"sneak_to_server": {"text": "Пойти тихо по карте.", "next": "server_approach"}},
    },

    "blackmail_fail": {
        "text": (
            "Шантаж не проходит — тебя выставляют на улицу. Утерянное время дорого стоит: патруль усилился.\n"
            "Ты вынужден вернуться к одиночному пути."
        ),
        "choices": {"continue_alone": {"text": "Продолжить в одиночку.", "next": "shadow_pass"}},
    },

    "server_approach": {
        "text": (
            "Ты выходишь к утопленному в темноте шлюзу — там, где расположена серверная. "
            "Перед дверью три контроля: биометрический, электрический и логин-терминал."
        ),
        "choices": {
            "biometric": {"text": "Попробовать биометрический обход (если есть карта).", "next": "bio_check"},
            "brute": {"text": "Взломать электрическую панель силой.", "next": "panel_break"},
            "terminal": {"text": "Взломать терминал — нужно время и знания.", "next": "terminal_hack"},
        },
    },

    "bio_check": {
        "text": (
            "Если у тебя есть карта доступа (или ты помогал санктууму) — биометрия пропускает тебя.\n"
            "Если нет — система блокирует попытку и вызывает защитный дрон."
        ),
        "choices": {
            "has_card": {"text": "Если у тебя была карта — войти.", "next": "server_inside"},
            "no_card": {"text": "Если карты нет — попытка провалилась.", "next": "droid_alert"},
        },
    },

    "panel_break": {
        "text": (
            "Ты ломишь панель. Это вызывает всплеск тока и краткую блокировку. "
            "Но сработала автономная защита — появился дрон."
        ),
        "choices": {
            "fight_droid": {"text": "Сразиться с дроном.", "next": "droid_battle"},
            "sneak_back": {"text": "Отступить и найти другой путь.", "next": "shadow_pass"},
        },
    },

    "terminal_hack": {
        "text": (
            "Взлом терминала потребует времени. Если ты учёный — успех вероятен. "
            "Если нет — риск ошибки с последствиями."
        ),
        "choices": {
            "hack_success": {"text": "Если ты учёный — удача, терминал открыт.", "next": "server_inside"},
            "hack_fail": {"text": "Если ты не учёный — система вызывает сигнал тревоги.", "next": "droid_alert"},
        },
    },

    "droid_alert": {
        "text": (
            "Сигнал тревоги! За тобой направляются охранные дроны.\n"
            "Бежать или попытаться спрятаться?"
        ),
        "choices": {
            "run_to_lab": {"text": "Бежать в сторону лаборатории — рискованно.", "next": "lab_front"},
            "hide_and_wait": {"text": "Укрыться и ждать окончания тревоги.", "next": "hide_wait"},
        },
    },

    "droid_battle": {
        "text": (
            "Дрон — опасная машина. Бой шумный и короткий. "
            "Ты легко подавляешь его (если солдат) или обходишь (если с помехогенератором)."
        ),
        "choices": {"enter_server": {"text": "Войти в серверную.", "next": "server_inside"}},
    },

    "hide_wait": {
        "text": (
            "Ты прячешься и наблюдаешь. Дроны патрулируют, но уходят по истечении сигнала.\n"
            "Путь свободен."
        ),
        "choices": {"enter_server": {"text": "Пойти в серверную.", "next": "server_inside"}},
    },

    "server_inside": {
        "text": (
            "Серверная — холодный зал со стеллажами. На главной панели есть доступ к логам проекта 'Эпсилон'.\n"
            "Нужно решить: скачать данные, уничтожить их или взять лишь часть."
        ),
        "choices": {
            "download_all": {"text": "Скачать всё — риск привлечь внимание.", "next": "download_complete"},
            "copy_fragment": {"text": "Скопировать фрагмент — менее заметно.", "next": "copy_fragment"},
            "destroy": {"text": "Уничтожить данные — лишить всех доступа (моральный выбор).", "next": "data_destroy"},
        },
    },

    "download_complete": {
        "text": (
            "Ты скачиваешь базу. Это долгий процесс. Система заметит активность и начнёт локальную блокировку.\n"
            "Ты успеваешь взять формулу вакцины и массивы данных о побочных эффектах."
        ),
        "choices": {
            "take_data": {"text": "Взять данные и бежать.", "next": "escape_with_data"},
            "stay_and_cover": {"text": "Остаться и попытаться уничтожить следы.", "next": "cover_tracks"},
        },
    },

    "copy_fragment": {
        "text": (
            "Ты копируешь только ключевые формулы — быстро и тихо.\n"
            "Но фрагмент не содержит всех методов стабилизации раствора — потребуются испытания."
        ),
        "choices": {"leave_quick": {"text": "Уйти с фрагментом.", "next": "escape_with_fragment"}},
    },

    "data_destroy": {
        "text": (
            "Ты решаешь: никто не должен контролировать вакцину. Уничтожая данные, ты лишаешь мир шанса на лечение, "
            "но и предотвращаешь злоупотребление.\n\n"
            "Это радикальный выбор с долгосрочными последствиями."
        ),
        "choices": {
            "destroy_yes": {"text": "Подтвердить уничтожение.", "next": "data_destroyed"},
            "abort": {"text": "Отменить и сохранить данные.", "next": "server_inside"},
        },
    },

    "escape_with_data": {
        "text": (
            "Ты бежишь по туннелям с данными. По дороге встречаешь торговую группу, которая хочет обменять тебя на информацию."
        ),
        "choices": {
            "trade_now": {"text": "Отдать часть данных за помощь.", "next": "trade_help"},
            "run": {"text": "Не торговать — бежать дальше.", "next": "final_tunnel_run"},
        },
    },

    "cover_tracks": {
        "text": (
            "Ты пытаешься стереть следы — это занимает время. К моменту завершения в серверную врываются фракции.\n"
            "В завязавшейся перестрелке ты ранен и теряешь данные."
        ),
        "choices": {
            "wounded_escape": {"text": "Пробраться наружу раненым.", "next": "wounded_out"},
        },
    },

    "escape_with_fragment": {
        "text": (
            "Фрагмент у тебя, но он неполон. Для стабилизации нужна лаборатория и реактивы.\n"
            "Тем не менее, это шанс."
        ),
        "choices": {"to_lab_prep": {"text": "Вернуться в убежище для подготовки.", "next": "prep_lab"}},
    },

    "data_destroyed": {
        "text": (
            "Данные уничтожены. Некоторые группы восторжествовали: 'Теперь никто не сможет создать оружие.' "
            "Другие обреченно шепчут: 'Мы потеряли шанс'.\n\n"
            "✅ Исход: данные уничтожены — мир защищён от злоупотреблений, но вакцины нет."
        ),
        "choices": {"ending_destroy": {"text": "Принять результат.", "next": "ending_destroy_explained"}},
    },

    "trade_help": {
        "text": (
            "Торговцы помогают тебе добраться до безопасного пункта. Они берут часть данных как залог.\n"
            "Ты остался жив и с материалом для работы."
        ),
        "choices": {"prep_lab": {"text": "Подготовиться к синтезу вакцины.", "next": "prep_lab"}},
    },

    "final_tunnel_run": {
        "text": (
            "Бегство заканчивается перед укреплённой дверью лаборатории — слишком много охраны.\n"
            "Без союзников или доступа — шансы малы."
        ),
        "choices": {
            "surrender": {"text": "Сдаться — надеясь на переговоры.", "next": "captured_final"},
            "retreat": {"text": "Отступить и искать другой путь.", "next": "chapter_2_start"},
        },
    },

    "captured_final": {
        "text": (
            "Тебя берут в плен охраной. Данные изъяты, а тебя оставляют в камере для допроса.\n\n"
            "❌ ПОРАЖЕНИЕ: попытка ворваться в охраняемую зону без поддержки."
        ),
        "choices": {"restart": {"text": "Начать заново.", "next": "intro"}},
    },

    "wounded_out": {
        "text": (
            "Раненый, но живой, ты выбираешь — скрыться в укрытии или попытаться связаться с центром выживших."
        ),
        "choices": {
            "hide_and_heal": {"text": "Исцелиться и восстановиться.", "next": "prep_lab"},
            "call_for_help": {"text": "Связаться и попросить эвакуацию.", "next": "rescued_by_faction"},
        },
    },

    "rescued_by_faction": {
        "text": (
            "Фракция выживших находит тебя и приютит, но потребует в обмен работу: либо помочь им, либо отдать фрагмент."
        ),
        "choices": {
            "work_for_them": {"text": "Работать на фракцию ради ресурсов.", "next": "prep_lab"},
            "hand_over_fragment": {"text": "Отдать фрагмент и уйти.", "next": "fragment_taken"},
        },
    },

    "fragment_taken": {
        "text": (
            "Фракция забирает фрагмент и обещает продолжить работу, но ты теряешь шанс самому контролировать вакцину.\n\n"
            "⚠️ Последствие: твой вклад исчез — исход зависит от их морали."
        ),
        "choices": {"chapter_end": {"text": "Принять и двигаться дальше.", "next": "chapter_3_start"}},
    },

    "prep_lab": {
        "text": (
            "Ты собираешь команду: учёный для синтеза, солдат для защиты, разведчик для проходов.\n"
            "Нужно решить стратегию — быстрый штурм лаборатории или медленная, аккуратная работа."
        ),
        "choices": {
            "fast_assault": {"text": "Быстрый штурм (рискованно, но возможно быстрее).", "next": "assault_begin"},
            "slow_plan": {"text": "Медленное планирование: собрать ресурсы и разведданные.", "next": "plan_and_wait"},
        },
    },

    "assault_begin": {
        "text": (
            "Выход — ночью. Штурм начинается. Охрана держит оборону лучше, чем ожидалось.\n"
            "В бою возможны потери."
        ),
        "choices": {
            "push": {"text": "Продолжать наступление любой ценой.", "next": "assault_climax"},
            "fallback": {"text": "Отступить и пересмотреть план.", "next": "prep_lab"},
        },
    },

    "assault_climax": {
        "text": (
            "В самый разгар штурма ты видишь: в лаборатории активирована система самоуничтожения.\n"
            "У тебя две секунды: спасти команду и уйти или остаться ради данных."
        ),
        "choices": {
            "save_team": {"text": "Спасти команду — побег.", "next": "team_saved_escape"},
            "stay_for_data": {"text": "Остаться — попытаться скачать всё (платная гибель возможна).", "next": "self_sacrifice"},
        },
    },

    "team_saved_escape": {
        "text": (
            "Вы рвётесь наружу, часть команды ранена, но жива. Вакцину не взять, но живые важнее.\n"
            "Вы уходите в подземелье, чтобы лечить раненых."
        ),
        "choices": {"chapter_end": {"text": "Уйти к следующей главе.", "next": "chapter_3_start"}},
    },

    "self_sacrifice": {
        "text": (
            "Ты остаёшься, стараясь выгрузить данные. Система срабатывает — взрыв.\n\n"
            "❌ ПОРАЖЕНИЕ (героическая гибель): ты погиб, но часть данных удалось переслать команде."
        ),
        "choices": {"restart": {"text": "Начать заново (или выбрать другой путь).", "next": "intro"}},
    },

    # -----------------------
    # ГЛАВА 3: СЕРДЦЕ БАШНИ
    # -----------------------
    "chapter_3_start": {
        "text": (
            "Глава 3 — Сердце Башни.\n\n"
            "Ты снова поднимаешься к лаборатории. Теперь на кону — не только вакцина, "
            "но и правда о проекте 'Эпсилон'. Ты должен решить, что делать с информацией."
        ),
        "choices": {
            "infiltrate_core": {"text": "Проникнуть в центральный сектор лаборатории.", "next": "core_anteroom"},
            "meet_director": {"text": "Попытаться найти и поговорить с директором проекта.", "next": "director_search"},
            "sabotage": {"text": "Скрытно саботировать системы охраны.", "next": "sabotage_begin"},
        },
    },

    "core_anteroom": {
        "text": (
            "Антре лаборатории — стеклянные панели, взгляд на центральный криоконсерватор.\n"
            "Охрана здесь строже. Нужен план: маскировка, взлом или убеждение."
        ),
        "choices": {
            "disguise": {"text": "Замаскироваться под сотрудника лаборатории.", "next": "disguise_check"},
            "force_entry": {"text": "Просто взломать дверь силой.", "next": "force_core"},
            "bribe": {"text": "Попытаться подкупить охранника.", "next": "bribe_guard"},
        },
    },

    "disguise_check": {
        "text": (
            "Если у тебя есть документы (полученные в предыдущих главах) — маскировка пройдет.\n"
            "Если нет — тебя спросят код."
        ),
        "choices": {
            "has_docs": {"text": "Если есть документы — вход свободен.", "next": "core_lab"},
            "no_docs": {"text": "Если документов нет — разоблачают.", "next": "core_alarm"},
        },
    },

    "force_core": {
        "text": (
            "Взлом привлекает внимание: внутренние роботы патрулируют коридоры.\n"
            "В бою возможны ранения, но ты добираешься до центральной лаборатории."
        ),
        "choices": {"enter_core": {"text": "Войти в центральную лабораторию.", "next": "core_lab"}},
    },

    "bribe_guard": {
        "text": (
            "Подкуп удаётся: охранник закрывает глаза в обмен на еду и обещание помощи.\n"
            "Но он просит взамен — вывод на крышу как безопасный путь."
        ),
        "choices": {
            "roof": {"text": "Принять и подняться на крышу.", "next": "roof_access"},
            "decline": {"text": "Отказать и войти другим путём.", "next": "force_core"},
        },
    },

    "core_lab": {
        "text": (
            "Ты в центральной лаборатории. В холодильниках — капсулы с образцами. "
            "На стене — терминал с логами и видеоархивом, где записаны эксперименты и приказания."
        ),
        "choices": {
            "read_logs": {"text": "Просмотреть логи и узнать правду.", "next": "reveal_origin"},
            "take_vaccine": {"text": "Забрать образец и уйти.", "next": "vaccine_taken"},
            "secure_room": {"text": "Запереть секцию и попытаться эвакуировать образцы.", "next": "secure_section"},
        },
    },

    "reveal_origin": {
        "text": (
            "Логи показывают: 'Эпсилон' задумывался как био-протектор, но был искажен коммерческими интересами. "
            "Часть ученых саботировала проект и спрятала полную формулу в личной базе данных."
        ),
        "choices": {
            "search_personal_db": {"text": "Найти личную базу данных учёного.", "next": "find_personal_db"},
            "expose": {"text": "Опубликовать логи сразу — риск хаоса.", "next": "publish_logs"},
            "take_and_flee": {"text": "Взять вакцину и уйти, не раскрывая правду.", "next": "vaccine_taken"},
        },
    },

    "find_personal_db": {
        "text": (
            "База спрятана в зашифрованном модуле. Только учёный или тот, кто знает секрет — откроет.\n"
            "Если ты учёный — шанс открыть выше."
        ),
        "choices": {
            "decrypt_by_skill": {"text": "Попытаться расшифровать (если ты учёный).", "next": "decrypt_success"},
            "force_db": {"text": "Взломать грубой силой (риск повреждения).", "next": "db_corrupt"},
            "leave": {"text": "Оставить и уйти с тем, что есть.", "next": "vaccine_taken"},
        },
    },

    "decrypt_success": {
        "text": (
            "Ты расшифровал базу: тут полная методика стабилизации вакцины и список побочных эффектов — "
            "ключ к безопасному массовому производству."
        ),
        "choices": {
            "share_with_factions": {"text": "Поделиться с союзниками — риск манипуляции.", "next": "share_choice"},
            "hide_and_control": {"text": "Скрыть данные и контролировать производство сам.", "next": "control_choice"},
        },
    },

    "db_corrupt": {
        "text": (
            "Взлом повредил часть данных. Часть формулы утеряна.\n\n"
            "❌ ПОРАЖЕНИЕ (частичная потеря): формула теперь неполна; без дополнительных исследований вакцина нестабильна."
        ),
        "choices": {"restart": {"text": "Начать заново.", "next": "intro"}},
    },

    "publish_logs": {
        "text": (
            "Ты публикуешь логи. Сеть взрывается: многие банды и центры выживших требуют доступ к вакцине.\n"
            "Это приводит к хаосу и попыткам контроля — последствия непредсказуемы."
        ),
        "choices": {
            "defend": {"text": "Защитить лабораторию от набегов.", "next": "lab_defense"},
            "retreat_with_vaccine": {"text": "Уйти с образцом, пока ещё возможно.", "next": "vaccine_taken"},
        },
    },

    "vaccine_taken": {
        "text": (
            "Ты уносишь капсулу. Часть команды радуется, но без полной методики есть риск побочных эффектов."
        ),
        "choices": {
            "deliver_to_bases": {"text": "Отнести образец в базы выживших для анализа.", "next": "deliver_bases"},
            "keep_for_self": {"text": "Скрыть образец и попытаться сам стабилизировать.", "next": "self_stabilize"},
        },
    },

    "secure_section": {
        "text": (
            "Ты тщательно упаковываешь образцы и закрываешь секцию. Это замедлит доступ посторонних, но не навсегда.\n"
            "Нужно решить маршрут вывоза."
        ),
        "choices": {
            "through_sewer": {"text": "Через канализацию — долго, но надёжно.", "next": "sewer_route"},
            "through_roof": {"text": "Через крышу — быстрее, но рисково.", "next": "roof_route"},
        },
    },

    "share_choice": {
        "text": (
            "Ты передаёшь методику группам, дав им возможность массового производства. "
            "Некоторые используют её честно, другие пытаются заработать."
        ),
        "choices": {
            "monitor_use": {"text": "Создать сеть надзора за производством.", "next": "monitoring_net"},
            "trust_local": {"text": "Довериться лидерам и уйти.", "next": "chapter_4_start"},
        },
    },

    "control_choice": {
        "text": (
            "Скрывая формулу, ты получаешь власть. Это даёт контроль, но и ответственность.\n"
            "Многим твоё решение не понравится."
        ),
        "choices": {
            "centralize": {"text": "Централизованное производство под твоим контролем.", "next": "central_factory"},
            "sell_access": {"text": "Продавать доступ за ресурсы.", "next": "sell_access_choice"},
        },
    },

    "lab_defense": {
        "text": (
            "Ты организуешь оборону. Бои длительны. Потери велики, но лаборатория устояла.\n"
            "Однако ресурсы истощены."
        ),
        "choices": {"rebuild": {"text": "Попытаться восстановить производство.", "next": "rebuild_effort"}},
    },

    "deliver_bases": {
        "text": (
            "Ты доставляешь образец в безопасный научный центр. Они обещают безопасные испытания и массовое производство."
        ),
        "choices": {"chapter_4": {"text": "Продолжить — последствия будут в главе 4.", "next": "chapter_4_start"}},
    },

    "self_stabilize": {
        "text": (
            "Ты пытаешься стабилизировать сам. Это требует реактивов и времени.\n"
            "Если ты учёный — шанс большой. Если нет — риск высок."
        ),
        "choices": {
            "succeed": {"text": "Если ты учёный — успех, вакцина готова.", "next": "chapter_4_start"},
            "fail": {"text": "Если не учёный — эксперимент провалился.", "next": "lab_accident"},
        },
    },

    "lab_accident": {
        "text": (
            "Неправильная формула вызвала вспышку заражения внутри убежища.\n\n"
            "❌ ПОРАЖЕНИЕ: эксперимент без достаточных знаний опасен."
        ),
        "choices": {"restart": {"text": "Начать заново.", "next": "intro"}},
    },

    "sewer_route": {
        "text": (
            "Через канализацию путь длинен, но вы успешно покидаете комплекс. По пути вам попадаются следы — возможно, предатели."
        ),
        "choices": {"investigate": {"text": "Проверить следы.", "next": "traitor_reveal"}, "ignore": {"text": "Игнорировать и идти дальше.", "next": "chapter_4_start"}},
    },

    "roof_route": {
        "text": (
            "Через крышу вас видят снайперы. Нужна тактика: уйти вверх или спуститься назад."
        ),
        "choices": {
            "confront_snipers": {"text": "Сразиться со снайперами.", "next": "sniper_fight"},
            "drop_back": {"text": "Отступить и искать другой путь.", "next": "shadow_pass"},
        },
    },

    "traitor_reveal": {
        "text": (
            "Следы приводят к информатору: он передал местоположение лаборатории конкурирующей группировке.\n"
            "Выбирай: отомстить, простить, использовать его."
        ),
        "choices": {
            "execute": {"text": "Казнить — устрашение.", "next": "execute_traitor"},
            "spare": {"text": "Помиловать и использовать как информатора.", "next": "use_informer"},
            "release": {"text": "Отпустить — риск повторения.", "next": "chapter_4_start"},
        },
    },

    "execute_traitor": {
        "text": (
            "Казнь вызывает страх, но усиливает ненависть. Вскоре группа, связанная с предателем, совершает нападение.\n\n"
            "❌ ПОРАЖЕНИЕ (политическое): местные фракции теряют доверие к тебе."
        ),
        "choices": {"restart": {"text": "Начать заново.", "next": "intro"}},
    },

    "use_informer": {
        "text": (
            "Информатор помогает: он ведёт тебя к секретной лаборатории с реактивами.\n"
            "Теперь у тебя есть всё необходимое для стабилизации."
        ),
        "choices": {"chapter_4": {"text": "Двигаться в главу 4 с ресурсами.", "next": "chapter_4_start"}},
    },

    "sniper_fight": {
        "text": (
            "Снайперы — профессионалы. Если ты солдат, ты имеешь шанс их нейтрализовать.\n"
            "Если нет — тебя ранят."
        ),
        "choices": {
            "soldier_win": {"text": "Если ты солдат — победа.", "next": "chapter_4_start"},
            "not_soldier": {"text": "Если не солдат — ранение и отступление.", "next": "wounded_out"},
        },
    },

    # -----------------------
    # ГЛАВА 4: ЦЕНА СПАСЕНИЯ
    # -----------------------
    "chapter_4_start": {
        "text": (
            "Глава 4 — Цена спасения.\n\n"
            "Теперь у тебя вакцина или данные. Мир стоит перед выбором: массовое внедрение, локальная защита или продажа капиталу.\n"
            "Каждое решение несёт последствия."
        ),
        "choices": {
            "mass_release": {"text": "Массовый выпуск — риск быстрых изменений.", "next": "mass_production"},
            "controlled": {"text": "Контролируемая локальная вакцинация.", "next": "controlled_rollout"},
            "monetize": {"text": "Продать доступ — ресурсы для восстановления.", "next": "sell_to_power"},
            "destroy_all": {"text": "Уничтожить всё — предотвратить злоупотребления.", "next": "destroy_all_choice"},
        },
    },

    "mass_production": {
        "text": (
            "Массовое производство запускается. Это быстрый путь, но процессы контроля слабы.\n"
            "Некоторые партии оказываются не полностью стабилизированы — шанс побочных эффектов."
        ),
        "choices": {
            "monitor": {"text": "Создать команду мониторинга.", "next": "monitoring_net"},
            "push_faster": {"text": "Ускорить любой ценой.", "next": "mass_fast_fail"},
        },
    },

    "mass_fast_fail": {
        "text": (
            "В спешке смесь недостабилизирована: большой процент побочных эффектов. Паника, бунты.\n\n"
            "❌ ПОРАЖЕНИЕ: поспешные решения привели к катастрофе."
        ),
        "choices": {"restart": {"text": "Начать заново.", "next": "intro"}},
    },

    "controlled_rollout": {
        "text": (
            "Контролируемая кампания: сначала тестовая группа, затем масштабирование.\n"
            "Риски минимизированы, но времени требуется много."
        ),
        "choices": {
            "succeed_slow": {"text": "Если тесты успешны — вакцина безопасна.", "next": "ending_global_recovery"},
            "unexpected_issue": {"text": "Если тесты выявляют проблему — требуются корректировки.", "next": "research_loop"},
        },
    },

    "sell_to_power": {
        "text": (
            "Ты продаёшь доступ влиятельному центру — они обещают обмен ресурсами.\n"
            "Но власть часто коррумпирует: цена — контроль и зависимость."
        ),
        "choices": {
            "accept_offer": {"text": "Принять сделку.", "next": "power_takes_control"},
            "refuse": {"text": "Отказаться и сохранить независимость.", "next": "controlled_rollout"},
        },
    },

    "destroy_all_choice": {
        "text": (
            "Решение уничтожить всё радикально. Это защищает от злоупотреблений, но значит оставить людей без лекарства."
        ),
        "choices": {
            "destroy_confirm": {"text": "Подтвердить уничтожение.", "next": "ending_destroyed_world"},
            "spare_some": {"text": "Сохранить копию в тайне.", "next": "secret_cache"},
        },
    },

    "monitoring_net": {
        "text": (
            "Ты создаёшь сеть наблюдения и контроля качества. Это требует доверия и прозрачности."
        ),
        "choices": {
            "open_source": {"text": "Сделать методику открытой.", "next": "ending_open_source"},
            "regulate": {"text": "Создать регулятор под твоим контролем.", "next": "ending_regulated"},
        },
    },

    "research_loop": {
        "text": (
            "Проблемы в тестах требуют дополнительных исследований. Это может занять годы.\n"
            "Между тем, общество терпит потери."
        ),
        "choices": {
            "persist": {"text": "Продолжать исследования.", "next": "ending_persistent_research"},
            "abandon": {"text": "Отказаться — искать альтернативы.", "next": "ending_alternative_paths"},
        },
    },

    "power_takes_control": {
        "text": (
            "Власть использует вакцину для усиления влияния: доступ по прописке и службе.\n"
            "Многие обречены остаться без лечения."
        ),
        "choices": {
            "resist": {"text": "Возглавить сопротивление против власти.", "next": "resistance_start"},
            "comply": {"text": "Соглашаться ради стабильности.", "next": "ending_power_stable"},
        },
    },

    "resistance_start": {
        "text": (
            "Сопротивление набирает силу. Конфликт перерастает в открытую войну за доступ к вакцине."
        ),
        "choices": {
            "lead_battle": {"text": "Возглавить решающую атаку на крупный склад власти.", "next": "resistance_battle"},
            "sabotage_supply": {"text": "Саботировать поставки власти.", "next": "sabotage_supply_line"},
        },
    },

    "resistance_battle": {
        "text": (
            "Битва кровавая. Если ты потеряешь — власть сохранит монополию. Если выиграешь — возможна справедливость."
        ),
        "choices": {
            "victory": {"text": "Если победа — власть свергнута.", "next": "ending_resistance_victory"},
            "defeat": {"text": "Если поражение — ты погибаешь.", "next": "ending_resistance_loss"},
        },
    },

    "sabotage_supply_line": {
        "text": (
            "Саботаж ослабляет власть, но также наносит ущерб мирным группам, зависимым от поставок.\n"
            "Моральная дилемма."
        ),
        "choices": {
            "continue": {"text": "Принять цену ради свободы.", "next": "ending_sabotage_cost"},
            "stop": {"text": "Остановиться и искать другие пути.", "next": "controlled_rollout"},
        },
    },

    # -----------------------
    # ГЛАВА 5: ПОСЛЕДНИЙ РАССВЕТ (ФИНАЛ)
    # -----------------------
    "chapter_5_start": {
        "text": (
            "Глава 5 — Последний рассвет.\n\n"
            "Все сделанные решения сходятся: фракции, лаборатории, данные и мораль.\n"
            "Приготовься к финалу — возможно несколько разных концовок."
        ),
        "choices": {
            "final_act": {"text": "Перейти к последнему акту и завершить историю.", "next": "final_act_start"},
            "reflect": {"text": "Оглянуться на сделанные выборы и изменить некоторые решения.", "next": "revisit_choices"},
        },
    },

    "revisit_choices": {
        "text": (
            "Ты возвращаешься мысленно к ключевым решениям: уничтожение данных, продажа власти, открытая публикация.\n"
            "Некоторые изменения возможны, но многие последствия уже необратимы."
        ),
        "choices": {"proceed": {"text": "Принять прошлое и идти дальше.", "next": "final_act_start"}},
    },

    "final_act_start": {
        "text": (
            "Сейчас — кульминация. Твоя цель: обеспечить максимально справедливый и безопасный исход.\n"
            "Ты выбираешь стратегию: доверие, контроль или жертва."
        ),
        "choices": {
            "trust": {"text": "Довериться сообществу и сделать вакцину открытой.", "next": "final_open"},
            "control_final": {"text": "Удержать контроль и распределять выборочно.", "next": "final_control"},
            "sacrifice_final": {"text": "Пожертвовать собой ради безопасности (последняя попытка).", "next": "final_sacrifice"},
        },
    },

    "final_open": {
        "text": (
            "Открытая вакцинация запускается. Наука и сообщества мобилизуются.\n"
            "Первые месяцы — тяжёлые, но адаптации происходят быстро благодаря коллективным усилиям."
        ),
        "choices": {"ending_open_world": {"text": "Узнать исход.", "next": "ending_open_world"}},
    },

    "final_control": {
        "text": (
            "Контроль работает: сначала — порядок, потом — коррупция. Ты пытаешься поддерживать баланс, но это тяжело."
        ),
        "choices": {"ending_controlled_world": {"text": "Узнать исход.", "next": "ending_controlled_world"}},
    },

    "final_sacrifice": {
        "text": (
            "Ты активируешь устройство, которое сделает вакцину стабильной, но оно разрушит лабораторию и погубит тебя.\n"
            "Последняя запись: 'Пусть это будет шанс для других.'"
        ),
        "choices": {"ending_sacrifice": {"text": "Конец.", "next": "ending_sacrifice"}},
    },

    # --- Финальные тексты с пояснениями ---
    "ending_open_world": {
        "text": (
            "🏆 КОНЕЦ: 'Открытый восход'.\n\n"
            "Ты сделал методику общедоступной. Теперь миллионы учёных по миру совместно работают над адаптацией вакцины.\n"
            "ПОЯСНЕНИЕ: Этот путь медленнее, но максимизирует справедливость и минимизирует злоупотребления."
        ),
        "choices": {"restart": {"text": "Сыграть снова.", "next": "intro"}},
    },

    "ending_controlled_world": {
        "text": (
            "⚖️ КОНЕЦ: 'Порядок ценой свободы'.\n\n"
            "Вакцина распределяется централизованно: порядок и восстановление приходят быстро для избранных, "
            "но многие остаются за бортом.\n"
            "ПОЯСНЕНИЕ: Контроль спасает часть мира, но стимулирует неравенство и зависимость от власти."
        ),
        "choices": {"restart": {"text": "Сыграть снова и попробовать другой путь.", "next": "intro"}},
    },

    "ending_sacrifice": {
        "text": (
            "💥 КОНЕЦ: 'Пожертвование'.\n\n"
            "Ты уничтожил лабораторию, стабилизировав вакцину для дальнейшего распространения, но ценой собственной жизни.\n"
            "ПОЯСНЕНИЕ: Геройская жертва — быстрый и жёсткий путь к спасению, но утрата лидера оставляет вакуум власти."
        ),
        "choices": {"restart": {"text": "Начать заново.", "next": "intro"}},
    },

    "ending_resistance_victory": {
        "text": (
            "🏅 КОНЕЦ: 'Революция'.\n\n"
            "Сопротивление победило власть, вакцина распределяют более справедливо. Много потерь, но новая надежда.\n"
            "ПОЯСНЕНИЕ: Риск принес плоды — свобода и шанс на восстановление."
        ),
        "choices": {"restart": {"text": "Сыграть снова.", "next": "intro"}},
    },

    "ending_resistance_loss": {
        "text": (
            "❌ КОНЕЦ: 'Падение сопротивления'.\n\n"
            "Ты пожертвовал жизнью ради цели, но сопротивление было подавлено.\n"
            "ПОЯСНЕНИЕ: Иногда смелость не гарантирует успеха; последствия борьбы могут быть трагичными."
        ),
        "choices": {"restart": {"text": "Начать заново.", "next": "intro"}},
    },

    "ending_sabotage_cost": {
        "text": (
            "⚠️ КОНЕЦ: 'Цена свободы'.\n\n"
            "Саботаж ослабил власть, но нарушил поставки гуманитарной помощи: многие пострадали.\n"
            "ПОЯСНЕНИЕ: Тактические успехи обернулись тактическими потерями среди населения."
        ),
        "choices": {"restart": {"text": "Попробовать снова.", "next": "intro"}},
    },

    "ending_destroy_explained": {
        "text": (
            "🔚 КОНЕЦ: 'Уничтожение'.\n\n"
            "Ты уничтожил данные во имя безопасности. Это предотвратило злоупотребления, "
            "но лишило мир прямого шанса на лечение.\n"
            "ПОЯСНЕНИЕ: Иногда предотвращение опасности — это утрата надежды."
        ),
        "choices": {"restart": {"text": "Начать заново.", "next": "intro"}},
    },

    "ending_global_recovery": {
        "text": (
            "🌍 КОНЕЦ: 'Глобальное восстановление'.\n\n"
            "Медленные тесты и прозрачность дали устойчивый результат — вакцина внедрена безопасно, "
            "мир медленно восстанавливается.\n"
            "ПОЯСНЕНИЕ: Терпение и осторожность — платят долгосрочно."
        ),
        "choices": {"restart": {"text": "Сыграть снова.", "next": "intro"}},
    },

    "ending_persistent_research": {
        "text": (
            "🔬 КОНЕЦ: 'Упорство науки'.\n\n"
            "Ты посвятил годы исследованиям. Результат дал стабильную вакцину, но цена — поколение, жившее в ожидании.\n"
            "ПОЯСНЕНИЕ: Научный подход спасает, но требует времени и ресурсов."
        ),
        "choices": {"restart": {"text": "Начать новую попытку.", "next": "intro"}},
    },

    "ending_alternative_paths": {
        "text": (
            "⚗️ КОНЕЦ: 'Альтернативы'.\n\n"
            "Отказ от оригинальной методики заставил тебя искать иные решения: противовирусы, иммуномодуляторы — часть населения выжила, но мир уже другой."
        ),
        "choices": {"restart": {"text": "Попробовать ещё раз.", "next": "intro"}},
    },

    # Малые логические узлы / запасные сцены (могут потребоваться для связки)
    "lab_front": {
        "text": (
            "Ты стоишь у передней части лаборатории, но входы усилены. Нужно действовать быстро."
        ),
        "choices": {
            "sneak_in": {"text": "Попытаться проникнуть по тылам.", "next": "core_anteroom"},
            "call": {"text": "Позвать союзников.", "next": "prep_lab"}
        },
    },

    "hide_wait": {"text": "Ты прячешься, тревога спала.", "choices": {"continue": {"text": "Идти дальше.", "next": "server_inside"}}},

    # Несколько дополнительных концовок / пояснений
    "ending_power_stable": {
        "text": (
            "Власть удержала контроль, стабилизировала основные области, но цена — свобода и справедливость."
        ),
        "choices": {"restart": {"text": "Сыграть снова.", "next": "intro"}},
    },

    "ending_destroyed_world": {
        "text": (
            "Ты уничтожил все образцы и данные. Мир больше не получит вакцину.\n\n"
            "ПОЯСНЕНИЕ: Ты считал, что риск злоупотребления важнее шанса на спасение. Это морально обоснованный, но трагичный выбор."
        ),
        "choices": {"finalize": {"text": "Закончить игру.", "next": "chapter_5_start"}},
    },

    "secret_cache": {
        "text": (
            "Ты скрываешь копию формулы в тайном хранилище: шанс однажды безопасно восстановить производство.\n"
            "Но это одиночная надежда."
        ),
        "choices": {"move_on": {"text": "Перейти к финалу.", "next": "chapter_5_start"}},
    },

    "monitoring_net": {
        "text": (
            "Организация мониторинга потребует времени и доверия. Это непросто, но возможно."
        ),
        "choices": {"continue": {"text": "Продолжать.", "next": "chapter_5_start"}},
    },

    # Явные указания для переходов, используемые ранее
    "lab_accident": {
        "text": (
            "Ошибка в эксперименте привела к локальной вспышке и гибели части группы."
        ),
        "choices": {"restart": {"text": "Начать заново.", "next": "intro"}},
    },

    "captured_final": {
        "text": "Тебя захватили при попытке прорыва.",
        "choices": {"restart": {"text": "Начать заново.", "next": "intro"}},
    },

    "wounded_out": {
        "text": "Тебя увели, ты ранен, но жив.",
        "choices": {"restart": {"text": "Продолжить (в сюжете предполагается переход).", "next": "prep_lab"}},
    },

    # если нужно — добавь свои узлы здесь
}

# Примечание:
# - Этот файл содержит базовую, вручную прописанную структуру глав 1–5.
# - В bot.py при обработке выбора нужно:
#    1) сохранять роль, если вариант имеет поле "role": players[user_id]["role"] = choice["role"]
#    2) поддерживать players[user_id]["current"] как строку (ключ сцены)
#    3) при условных вариантах (например "has_card", "hack_success", "soldier_win") —
#       бот должен проверять состояние игрока (role, предметы, флаги) и направлять на соответствующий вариант.
#
# Если хочешь, я:
# - подготовлю версию bot.py, которая умеет автоматически разрешать условные выборы (по роли и инвентарю),
# - или распишу весь story.py до 400–500 уникальных сцен (полностью вручную).
#
# Готов продолжить — скажи, в каком формате хочешь дальнейшее расширение.
